<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥ç¸¾æ•ˆèˆ‡çé‡‘ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --bg: #f4f7f6; --accent: #3498db; --lock: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: var(--primary); border-left: 5px solid var(--accent); padding-left: 10px; margin-top: 0; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .score-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-red { background: var(--lock); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #f2f2f2; }
        .secret-data { filter: blur(5px); pointer-events: none; user-select: none; }
        .unlocked .secret-data { filter: none; pointer-events: auto; }
        #chartArea { height: 350px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>1. å“¡å·¥ç¸¾æ•ˆåˆ†æ•¸è¼¸å…¥ (äººè³‡åŠ©ç†ç”¨)</h2>
        <div class="input-grid">
            <div>
                <label>é¸æ“‡å“¡å·¥</label>
                <select id="selEmp" onchange="loadEmployeeTrend()"></select>
            </div>
            <div>
                <label>è€ƒè©•å¹´åº¦</label>
                <input type="number" id="calcYear" value="2025">
            </div>
            <div>
                <label>å°ˆæ¡ˆè¡¨ç¾åˆ†æ•¸</label>
                <input type="number" id="projScore" placeholder="0-100">
            </div>
        </div>
        
        <div id="scoreInputs" class="score-box">
            </div>
        
        <div style="margin-top: 15px; text-align: right;">
            <button class="btn btn-blue" onclick="startCalc()">åŸ·è¡Œè¨ˆç®—</button>
        </div>
    </div>

    <div class="card">
        <h2>2. å“¡å·¥å¾—åˆ†è¶¨å‹¢åˆ†æ</h2>
        <div id="chartArea">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <div class="card" id="bonusZone">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>3. çé‡‘è©¦ç®—çµæœ</h2>
            <button class="btn btn-red" id="unlockBtn" onclick="askPassword()">ğŸ”’ è¼¸å…¥å¯†ç¢¼æŸ¥çœ‹é‡‘é¡</button>
        </div>
        
        <div class="secret-data">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>å§“å</th><th>å¹´åº¦å¹³å‡åˆ†</th><th>äº”ä¸€</th><th>ç«¯åˆ</th><th>ä¸­ç§‹</th><th>å¹´çµ‚</th><th>ç¸½è¨ˆ</th><th>å¯¦ä»˜ä¿®æ”¹</th><th class="no-print">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9kLPJjKS5XZsYmgy_Hk77YKKL7X_8qIJkQrNGyJLEcGb3XKrb0lotAjcNhRCL5EXB/exec"; // ğŸ‘ˆ è«‹å¡«å…¥ä½ çš„ Apps Script ç¶²å€
    let currentAdminPwd = "";
    let trendChart = null;
    let empDataCache = [];

    window.onload = async () => {
    try {
        // ç›´æ¥å° API ç¶²å€ç™¼é€ GET è«‹æ±‚ï¼Œé€™æœƒè§¸ç™¼å¾Œç«¯çš„ doGet
        const res = await fetch(API_URL, {
            method: "GET",
            redirect: "follow"
        });
        const result = await res.json();
        
        if (result.status === "success") {
            empDataCache = result.data;
            const sel = document.getElementById('selEmp');
            // å¡«å…¥ä¸‹æ‹‰é¸å–®
            sel.innerHTML = empDataCache.map(e => 
                `<option value="${e.name}" data-rank="${e.rank}">${e.name} (${e.rank})</option>`
            ).join('');
            updateScoreUI();
        }
    } catch (err) {
        console.error("è¼‰å…¥åå–®å¤±æ•—:", err);
    }
};

    function updateScoreUI() {
        const sel = document.getElementById('selEmp');
        const rank = sel.options[sel.selectedIndex].dataset.rank;
        const box = document.getElementById('scoreInputs');
        let type = (rank === 'L1') ? 'æœˆä»½' : 'å­£åº¦';
        let count = (rank === 'L1') ? 12 : 4;
        
        let html = `<strong>${type}è©•åˆ†ï¼š</strong><br><div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">`;
        for(let i=1; i<=count; i++) {
            html += `<div style="text-align:center;"><small>${i}${type === 'æœˆä»½' ? 'æœˆ':'å­£'}</small><br><input type="number" class="q-score" style="width:50px;" onchange="updateChart()"></div>`;
        }
        html += `</div>`;
        box.innerHTML = html;
        updateChart();
    }

    // æ›²ç·šåœ–é‚è¼¯
    function updateChart() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => parseFloat(i.value) || 0);
        const labels = Array.from(document.querySelectorAll('.q-score')).map((_, i) => `${i+1}`);
        
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å€‹äººè©•åˆ†è¶¨å‹¢',
                    data: scores,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // è§£é–å¯†ç¢¼
    function askPassword() {
        const pwd = prompt("è«‹è¼¸å…¥é«˜éšä¸»ç®¡ç®¡ç†å¯†ç¢¼ï¼š");
        if (pwd) {
            currentAdminPwd = pwd;
            document.getElementById('bonusZone').classList.add('unlocked');
            document.getElementById('unlockBtn').innerText = "ğŸ”“ å·²æˆæ¬Šæª¢è¦–é‡‘é¡";
            document.getElementById('unlockBtn').classList.replace('btn-red', 'btn-blue');
        }
    }

    async function startCalc() {
        const name = document.getElementById('selEmp').value;
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => parseFloat(i.value) || 0);
        const proj = document.getElementById('projScore').value;
        const year = document.getElementById('calcYear').value;

        // å‘å¾Œç«¯è«‹æ±‚è¨ˆç®— (æ­¤è™•éœ€å¸¶å¯†ç¢¼ï¼Œè‹¥æ²’è§£é–æœƒå ±éŒ¯)
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "calculateBonus",
                password: currentAdminPwd,
                empName: name,
                scores: scores,
                projScore: proj,
                year: year
            })
        });
        const result = await res.json();
        
        if(result.status === "success") {
            const d = result.data;
            document.getElementById('resultBody').innerHTML += `
                <tr>
                    <td>${name}</td>
                    <td>${d.avgScore}</td>
                    <td>${d.laborDay}</td>
                    <td>${d.dragonBoat}</td>
                    <td>${d.midAutumn}</td>
                    <td>${d.yearEnd}</td>
                    <td style="font-weight:bold; color:red;">${d.systemTotal}</td>
                    <td><input type="number" value="${d.systemTotal}"></td>
                    <td><button onclick="this.closest('tr').remove()">åˆªé™¤</button></td>
                </tr>
            `;
        } else {
            alert("è¨ˆç®—å¤±æ•—ï¼š" + result.msg + " (å¯èƒ½å°šæœªè§£é–æˆ–æ¬Šé™ä¸è¶³)");
        }
    }
</script>
</body>
</html>
