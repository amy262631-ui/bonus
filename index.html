<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çé‡‘ç³»çµ± - å°ˆæ¡ˆåŠ æ¬Šèˆ‡è·ç­‰é€£å‹•ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --accent: #3498db; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        /* è¼¸å…¥æ¡†åŠ å¤§ */
        .q-score, .p-score { width: 65px; height: 40px; text-align: center; border: 2px solid var(--accent); border-radius: 6px; margin: 2px; }
        .p-score { border-color: #e67e22; } /* å°ˆæ¡ˆåˆ†æ•¸ç”¨æ©˜è‰²å€åˆ† */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .section-title { font-weight: bold; margin-top: 15px; color: #2c3e50; display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .adjust-input { width: 80px; text-align: center; color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>1. ç¸¾æ•ˆèˆ‡å°ˆæ¡ˆåˆ†æ•¸è¼¸å…¥ (åŠ©ç†)</h2>
    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
        <div>é¸æ“‡å“¡å·¥ï¼š<select id="selEmp" onchange="updateUI()"></select></div>
        <div>å¹´åº¦ï¼š<input type="number" id="calcYear" value="2025" style="width:70px;"></div>
        <button class="btn" style="background: var(--success);" onclick="handleFinalSave()">æ­£å¼å­˜æª”</button>
    </div>

    <span class="section-title" id="scoreTitle">ç¸¾æ•ˆè©•åˆ†</span>
    <div id="scoreInputs" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>

    <span class="section-title">å°ˆæ¡ˆè©•åˆ† (12å€‹æœˆåŠ æ¬Šå¹³å‡)</span>
    <div id="projInputs" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
    
    <div style="height: 300px; margin-top: 20px;"><canvas id="trendChart"></canvas></div>
</div>

<div class="card">
    <h2>2. çé‡‘æ ¸å®š (ä¸»ç®¡) <button class="btn" style="background: #e74c3c;" onclick="askUnlock()">ğŸ”’ è§£é–</button></h2>
    <div id="bonusZone" style="filter: blur(8px); pointer-events: none;">
        <table>
            <thead>
                <tr><th>å§“å</th><th>ç¸¾æ•ˆå¹³å‡</th><th>å°ˆæ¡ˆå¹³å‡</th><th>äº”ä¸€</th><th>ç«¯åˆ</th><th>ä¸­ç§‹</th><th>å¹´çµ‚</th><th>ç¸½è¨ˆ</th></tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9kLPJjKS5XZsYmgy_Hk77YKKL7X_8qIJkQrNGyJLEcGb3XKrb0lotAjcNhRCL5EXB/exec"; 
    let trendChart = null;
    Chart.register(ChartDataLabels);

    window.onload = async () => {
        const res = await fetch(API_URL);
        const result = await res.json();
        const sel = document.getElementById('selEmp');
        // ç¢ºä¿ data-rank æ­£ç¢ºå¯«å…¥
        sel.innerHTML = result.data.map(e => `<option value="${e.name}" data-rank="${e.rank}">${e.name} (${e.rank})</option>`).join('');
        updateUI();
    };

    // æ ¸å¿ƒé€£å‹•ï¼šåˆ‡æ›äººå“¡æ™‚é‡æ§‹è¼¸å…¥æ¡†
    function updateUI() {
        const sel = document.getElementById('selEmp');
        const rank = sel.options[sel.selectedIndex].dataset.rank;
        
        // 1. é‡æ§‹ç¸¾æ•ˆåˆ†æ•¸ (L1=12, L2-4=4)
        const sBox = document.getElementById('scoreInputs');
        let sCount = (rank === 'L1') ? 12 : 4;
        document.getElementById('scoreTitle').innerText = (rank === 'L1') ? "ç¸¾æ•ˆè©•åˆ† (æ¯æœˆ)" : "ç¸¾æ•ˆè©•åˆ† (æ¯å­£)";
        
        let sHtml = '';
        for(let i=1; i<=sCount; i++) {
            sHtml += `<div><small>${rank==='L1'?i:'Q'+i}</small><br><input type="number" class="q-score" onchange="autoCalc()"></div>`;
        }
        sBox.innerHTML = sHtml;

        // 2. é‡æ§‹å°ˆæ¡ˆåˆ†æ•¸ (æ°¸é  12 å€‹æœˆ)
        const pBox = document.getElementById('projInputs');
        let pHtml = '';
        for(let i=1; i<=12; i++) {
            pHtml += `<div><small>${i}æœˆ</small><br><input type="number" class="p-score" onchange="autoCalc()"></div>`;
        }
        pBox.innerHTML = pHtml;

        autoCalc(); // åˆå§‹åŒ–æ¸…ç©º
    }

    async function autoCalc() {
        updateChart();
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        const projScores = Array.from(document.querySelectorAll('.p-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        
        // åªè¦æœ‰ä»»ä¸€åˆ†æ•¸å°±é€å‡ºè©¦ç®—
        if (scores.some(s => s !== null) || projScores.some(s => s !== null)) {
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "calculateBonus", password: "0000",
                    empName: document.getElementById('selEmp').value,
                    scores: scores, projScores: projScores,
                    year: document.getElementById('calcYear').value
                })
            });
            const r = await res.json();
            if (r.status === "success") {
                renderTable(r.data);
            }
        }
    }

    function renderTable(d) {
        const name = document.getElementById('selEmp').value;
        const total = d.f1 + d.f2 + d.f3 + d.ye + d.proj;
        document.getElementById('resultBody').innerHTML = `
            <tr>
                <td>${name}</td><td>${d.avgScore}</td><td>${d.avgProjScore}</td>
                <td><input type="number" class="adjust-input" value="${d.f1}"></td>
                <td><input type="number" class="adjust-input" value="${d.f2}"></td>
                <td><input type="number" class="adjust-input" value="${d.f3}"></td>
                <td><input type="number" class="adjust-input" value="${d.ye}"></td>
                <td style="color:red; font-weight:bold;">${total.toLocaleString()}</td>
            </tr>`;
    }

    function updateChart() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: scores.map((_, i) => i+1),
                datasets: [{ label: 'ç¸¾æ•ˆè©•åˆ†', data: scores, borderColor: '#3498db', pointRadius: 5 }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { datalabels: { align: 'top', formatter: v => v || '' } }
            }
        });
    }

    async function handleFinalSave() {
        const p = prompt("è«‹è¼¸å…¥å¯†ç¢¼ä»¥æ­£å¼å­˜æª”ï¼š");
        if(p !== "0000") return alert("å¯†ç¢¼éŒ¯èª¤");
        
        // æŠ“å–ä¿®æ”¹å¾Œçš„å¯¦ä»˜é‡‘é¡
        const adjs = Array.from(document.querySelectorAll('.adjust-input')).map(i => parseFloat(i.value) || 0);
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveRecord", password: p,
                empName: document.getElementById('selEmp').value,
                year: document.getElementById('calcYear').value,
                f1: adjs[0], f2: adjs[1], f3: adjs[2], ye: adjs[3], total: adjs.reduce((a,b)=>a+b,0)
            })
        });
        const r = await res.json();
        if(r.status === "success") alert("å­˜æª”æˆåŠŸï¼");
    }

    function askUnlock() {
        const p = prompt("è«‹è¼¸å…¥å¯†ç¢¼è§£é–æ©Ÿå¯†é‡‘é¡ï¼š");
        if(p === "0000") document.getElementById('bonusZone').style.filter = "none";
    }
</script>
</body>
</html>
