<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çé‡‘ç®¡ç†ç³»çµ± - å­˜æª”æŒ‰éˆ•ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --lock: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .score-container { display: flex; flex-wrap: wrap; gap: 8px; background: #eef2f7; padding: 15px; border-radius: 10px; }
        .q-score { width: 60px; height: 35px; text-align: center; border: 2px solid var(--accent); border-radius: 6px; font-weight: bold; }
        .adjust-input { width: 90px; color: #d35400; font-weight: bold; border: 2px dashed #e67e22; text-align: center; background: #fffaf0; }
        #adminZone { display: none; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .total-cell { background: #fff3cd; color: red; font-weight: bold; font-size: 1.2rem; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; transition: 0.3s; }
    </style>
</head>
<body>

<div class="card">
    <h2>1. ç¸¾æ•ˆè©•åˆ†è¼¸å…¥</h2>
    <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
        å“¡å·¥ï¼š<select id="selEmp" onchange="initUI()"></select>
        å¹´åº¦ï¼š<input type="number" id="calcYear" value="2025" style="width:75px;" onchange="autoCalc()">
        <button class="btn" style="background:var(--lock);" id="unlockBtn" onclick="askPassword()">ğŸ”’ ä¸»ç®¡è§£é–/æ™‰å‡è¨­å®š</button>
    </div>
    <div id="scoreInputs" class="score-container"></div>
    <div style="height: 200px; margin-top:10px;"><canvas id="scoreChart"></canvas></div>
</div>

<div id="adminZone">
    <div class="card">
        <h2 style="color:#e67e22">2. å¹´åº¦ç•°å‹• Snapshot (æ™‰å‡/èª¿è–ªè¨­å®š)</h2>
        <table style="background:#fffdf0;">
            <thead><tr><th>å­£åº¦</th><th>Q1 (äº”ä¸€)</th><th>Q2 (ç«¯åˆ)</th><th>Q3 (ä¸­ç§‹)</th><th>Q4 (å¹´çµ‚)</th></tr></thead>
            <tbody id="timelineBody"></tbody>
        </table>
        <button class="btn" style="background:var(--accent)" onclick="autoCalc()">å¥—ç”¨è®Šå‹•ä¸¦è¨ˆç®—</button>
    </div>

    <div class="card">
        <h2>3. çé‡‘æ ¸å®šçµæœ</h2>
        <table>
            <thead><tr style="background:#eee;"><th>å§“å</th><th>å¹´åº¦</th><th>å¹³å‡åˆ†</th><th>äº”ä¸€</th><th>ç«¯åˆ</th><th>ä¸­ç§‹</th><th>å¹´çµ‚</th><th>ç¸½è¨ˆ</th></tr></thead>
            <tbody id="resultBody"></tbody>
        </table>
        
        <div style="text-align:right; margin-top:20px;">
            <button onclick="handleSave()" id="realSaveBtn" class="btn" style="background:var(--success); padding: 15px 40px; font-size: 1.1rem;">âœ… å„²å­˜å¹´åº¦ç´€éŒ„</button>
        </div>
        
        <div style="height: 250px; margin-top:20px;"><canvas id="yearTrendChart"></canvas></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9kLPJjKS5XZsYmgy_Hk77YKKL7X_8qIJkQrNGyJLEcGb3XKrb0lotAjcNhRCL5EXB/exec"; 
    let scoreChart = null, yearTrendChart = null, timelineData = {}, empMaster = [];

    window.onload = async () => {
        const res = await fetch(API_URL);
        const r = await res.json();
        empMaster = r.data;
        document.getElementById('selEmp').innerHTML = empMaster.map(e => `<option value="${e.name}" data-rank="${e.rank}" data-salary="${e.salary}">${e.name}</option>`).join('');
        initUI();
    };

    function initUI() {
        const sel = document.getElementById('selEmp');
        const opt = sel.options[sel.selectedIndex];
        const rank = opt.dataset.rank;
        const salary = parseFloat(opt.dataset.salary);
        
        document.getElementById('scoreInputs').innerHTML = Array.from({length: (rank==='L1'?12:4)}, (_, i) => 
            `<div><small>${i+1}${rank==='L1'?'M':'Q'}</small><br><input type="number" class="q-score" oninput="updateScoreChart(); autoCalc();"></div>`).join('');
        
        timelineData = { Q1:{r:rank, s:salary}, Q2:{r:rank, s:salary}, Q3:{r:rank, s:salary}, Q4:{r:rank, s:salary} };
        renderTimeline();
        autoCalc();
    }

    function renderTimeline() {
        let hRank = "<tr><td>è·ç­‰</td>", hSalary = "<tr><td>æœˆè–ª</td>";
        for(let i=1; i<=4; i++) {
            hRank += `<td><select id="t_r_Q${i}" onchange="autoCalc()"><option>L1</option><option>L2</option><option>L3</option><option>L4</option></select></td>`;
            hSalary += `<td><input type="number" id="t_s_Q${i}" style="width:85px" oninput="autoCalc()"></td>`;
        }
        document.getElementById('timelineBody').innerHTML = hRank + "</tr>" + hSalary + "</tr>";
        for(let i=1; i<=4; i++) {
            document.getElementById(`t_r_Q${i}`).value = timelineData[`Q${i}`].r;
            document.getElementById(`t_s_Q${i}`).value = timelineData[`Q${i}`].s;
        }
    }

    async function autoCalc() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        if(document.getElementById('t_r_Q1')) {
            for(let i=1; i<=4; i++) {
                timelineData["Q"+i] = { r: document.getElementById(`t_r_Q${i}`).value, s: parseFloat(document.getElementById(`t_s_Q${i}`).value) || 0 };
            }
        }
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "calculateBonus", empName: document.getElementById('selEmp').value, year: document.getElementById('calcYear').value, scores, timeline: timelineData })
        });
        const r = await res.json();
        if(r.status === "success") {
            if(r.historyScores) {
                const inputs = document.querySelectorAll('.q-score');
                r.historyScores.forEach((v, i) => { if (v !== null && inputs[i] && inputs[i].value === "") inputs[i].value = v; });
                updateScoreChart();
            }
            document.getElementById('resultBody').innerHTML = `
                <tr>
                    <td>${document.getElementById('selEmp').value}</td><td>${document.getElementById('calcYear').value}</td>
                    <td id="avgScoreDisplay">${r.data.avgScore}</td>
                    <td><input type="number" class="adjust-input" id="adj_f1" value="${r.data.f1}" oninput="refreshTotal()"></td>
                    <td><input type="number" class="adjust-input" id="adj_f2" value="${r.data.f2}" oninput="refreshTotal()"></td>
                    <td><input type="number" class="adjust-input" id="adj_f3" value="${r.data.f3}" oninput="refreshTotal()"></td>
                    <td><input type="number" class="adjust-input" id="adj_ye" value="${r.data.ye}" oninput="refreshTotal()"></td>
                    <td class="total-cell" id="totalCell">${(r.data.f1+r.data.f2+r.data.f3+r.data.ye).toLocaleString()}</td>
                </tr>`;
        }
    }

    function refreshTotal() {
        const adjs = ["f1","f2","f3","ye"].map(id => parseFloat(document.getElementById("adj_"+id).value) || 0);
        document.getElementById('totalCell').innerText = adjs.reduce((a,b)=>a+b,0).toLocaleString();
    }

    async function handleSave() {
        const btn = document.getElementById('realSaveBtn');
        btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";
        const adjs = ["f1","f2","f3","ye"].map(id => parseFloat(document.getElementById("adj_"+id).value) || 0);
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveRecord", year: document.getElementById('calcYear').value, empName: document.getElementById('selEmp').value,
                rank: timelineData.Q4.r, avgScore: document.getElementById('avgScoreDisplay').innerText,
                f1: adjs[0], f2: adjs[1], f3: adjs[2], ye: adjs[3], total: adjs.reduce((a,b)=>a+b,0),
                scores: scores, timeline: timelineData
            })
        });
        if((await res.json()).status === "success") { alert("âœ… å­˜æª”æˆåŠŸï¼"); loadTrend(); }
        btn.disabled = false; btn.innerText = "âœ… å„²å­˜å¹´åº¦ç´€éŒ„";
    }

    async function askPassword() {
        const p = prompt("ä¸»ç®¡å¯†ç¢¼ï¼š");
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "verifyPassword", password: p }) });
        const r = await res.json();
        if(r.status === "success") {
            document.getElementById('adminZone').style.display = 'block';
            document.getElementById('unlockBtn').style.display = 'none';
            loadTrend();
        } else alert("å¯†ç¢¼éŒ¯èª¤");
    }

    async function loadTrend() {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getPersonalTrend", empName: document.getElementById('selEmp').value }) });
        const r = await res.json();
        const ctx = document.getElementById('yearTrendChart').getContext('2d');
        if(yearTrendChart) yearTrendChart.destroy();
        yearTrendChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: r.data.map(d=>d.year+'å¹´'), datasets: [{ label: 'æ­·å¹´å¯¦é ˜ç¸½é¡', data: r.data.map(d=>d.total), backgroundColor: '#27ae60' }] },
            options: { maintainAspectRatio: false }
        });
    }

    function updateScoreChart() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value===""?null:parseFloat(i.value));
        const ctx = document.getElementById('scoreChart').getContext('2d');
        if (scoreChart) scoreChart.destroy();
        scoreChart = new Chart(ctx, {
            type: 'line',
            data: { labels: scores.map((_,i)=>i+1), datasets: [{ label: 'è©•åˆ†è¶¨å‹¢', data: scores, borderColor: '#3498db', tension: 0.3 }] },
            options: { maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>
