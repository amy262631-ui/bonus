<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çé‡‘ç®¡ç†ç³»çµ± - ä¸»ç®¡æˆæ¬Šå®Œæ•´ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --lock: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .score-container { display: flex; flex-wrap: wrap; gap: 8px; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .q-score, .p-score { width: 65px; height: 40px; text-align: center; border: 2px solid var(--accent); border-radius: 6px; font-weight: bold; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; }
        .adjust-input { width: 100px; color: #d35400; font-weight: bold; border: 2px solid #e67e22; text-align: center; background: #fff5e6; }
        
        /* æ ¸å¿ƒæ”¹è®Šï¼šéš±è—å€å¡Š */
        #adminZone { display: none; } /* é è¨­å®Œå…¨ä¸é¡¯ç¤º */
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        .total-cell { background: #fff3cd; color: red; font-weight: bold; font-size: 1.2em; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="card">
    <h2>1. å“¡å·¥åˆ†æ•¸è¼¸å…¥ (åŠ©ç†/å…¬é–‹)</h2>
    <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 15px;">
        <div>é¸æ“‡å“¡å·¥ï¼š<select id="selEmp" onchange="updateUI()"></select></div>
        <div>å¹´åº¦ï¼š<input type="number" id="calcYear" value="2025" style="width:70px;" onchange="autoCalc()"></div>
        <button class="btn" style="background:var(--lock);" id="unlockBtn" onclick="askPassword()">ğŸ”’ ä¸»ç®¡è§£é– (æ ¸å®šèˆ‡æ­·å¹´è¶¨å‹¢)</button>
    </div>
    
    <label>ç¸¾æ•ˆåˆ†æ•¸ï¼š</label>
    <div id="scoreInputs" class="score-container"></div>
    <label>å°ˆæ¡ˆåˆ†æ•¸ï¼š</label>
    <div id="projInputs" class="score-container"></div>
    
    <div style="height: 250px;"><canvas id="scoreChart"></canvas></div>
</div>

<div id="adminZone">
    <div class="card">
        <h2>2. å¯¦é ˜çé‡‘æ ¸å®š (å¯åŠ æ¸›èª¿æ•´)</h2>
        <p style="color: #666; font-size: 0.9em;">â€» ä¿®æ”¹ä¸‹æ–¹æ¡†å…§é‡‘é¡ï¼Œç³»çµ±ç¸½è¨ˆå°‡å³æ™‚æ›´æ–°ã€‚</p>
        <table>
            <thead>
                <tr><th>å§“å</th><th>å¹´åº¦</th><th>å¹³å‡åˆ†æ•¸</th><th>äº”ä¸€</th><th>ç«¯åˆ</th><th>ä¸­ç§‹</th><th>å¹´çµ‚</th><th>å°ˆæ¡ˆ</th><th>ç¸½è¨ˆ</th></tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
        <div style="text-align: right; margin-top: 15px;">
            <button class="btn" style="background:var(--success); padding: 15px 30px;" onclick="handleFinalSave()">âœ… ç¢ºèªé‡‘é¡ä¸¦å­˜æª”</button>
        </div>
    </div>

    <div class="card">
        <h2>3. å€‹äººæ­·å¹´å¯¦é ˜è¶¨å‹¢ (2023-2025)</h2>
        <div style="height: 300px;"><canvas id="yearTrendChart"></canvas></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9kLPJjKS5XZsYmgy_Hk77YKKL7X_8qIJkQrNGyJLEcGb3XKrb0lotAjcNhRCL5EXB/exec"; 
    let scoreChart = null, yearTrendChart = null;
    Chart.register(ChartDataLabels);

    window.onload = async () => {
        const res = await fetch(API_URL);
        const result = await res.json();
        const sel = document.getElementById('selEmp');
        sel.innerHTML = result.data.map(e => `<option value="${e.name}" data-rank="${e.rank}">${e.name}</option>`).join('');
        updateUI();
    };

    function updateUI() {
        const sel = document.getElementById('selEmp');
        const rank = sel.options[sel.selectedIndex].dataset.rank;
        document.getElementById('scoreInputs').innerHTML = Array.from({length: (rank === 'L1' ? 12 : 4)}, (_, i) => 
            `<div><small>${rank==='L1'?(i+1)+'M':'Q'+(i+1)}</small><br><input type="number" class="q-score" onchange="onChanged()"></div>`).join('');
        document.getElementById('projInputs').innerHTML = Array.from({length: 12}, (_, i) => 
            `<div><small>${i+1}M</small><br><input type="number" class="p-score" onchange="onChanged()"></div>`).join('');
        autoCalc();
    }

    function onChanged() { updateScoreChart(); autoCalc(); }

    async function autoCalc() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value===""?null:parseFloat(i.value));
        const projScores = Array.from(document.querySelectorAll('.p-score')).map(i => i.value===""?null:parseFloat(i.value));
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "calculateBonus", empName: document.getElementById('selEmp').value, scores, projScores, year: document.getElementById('calcYear').value })
        });
        const r = await res.json();
        if(r.status === "success") {
            // æ­·å²å›å¡«
            if(r.historyScores) {
                const hist = JSON.parse(r.historyScores);
                const qIn = document.querySelectorAll('.q-score'), pIn = document.querySelectorAll('.p-score');
                hist.s.forEach((v, i) => { if(v && !qIn[i].value) qIn[i].value = v; });
                hist.p.forEach((v, i) => { if(v && !pIn[i].value) pIn[i].value = v; });
                updateScoreChart();
            }
            renderAdminTable(r.data);
            if(document.getElementById('adminZone').style.display === 'block') loadYearTrend();
        }
    }

    function renderAdminTable(d) {
        document.getElementById('resultBody').innerHTML = `
            <tr>
                <td>${document.getElementById('selEmp').value}</td>
                <td>${document.getElementById('calcYear').value}</td>
                <td>${d.avgScore}</td>
                <td><input type="number" class="adjust-input" id="adj_f1" value="${d.f1}" oninput="refreshTotal()"></td>
                <td><input type="number" class="adjust-input" id="adj_f2" value="${d.f2}" oninput="refreshTotal()"></td>
                <td><input type="number" class="adjust-input" id="adj_f3" value="${d.f3}" oninput="refreshTotal()"></td>
                <td><input type="number" class="adjust-input" id="adj_ye" value="${d.ye}" oninput="refreshTotal()"></td>
                <td id="cellProj">${d.proj.toLocaleString()}</td>
                <td class="total-cell" id="cellTotal">${d.systemTotal.toLocaleString()}</td>
            </tr>`;
    }

    function refreshTotal() {
        const f1 = parseFloat(document.getElementById('adj_f1').value) || 0;
        const f2 = parseFloat(document.getElementById('adj_f2').value) || 0;
        const f3 = parseFloat(document.getElementById('adj_f3').value) || 0;
        const ye = parseFloat(document.getElementById('adj_ye').value) || 0;
        const proj = parseFloat(document.getElementById('cellProj').innerText.replace(/,/g,'')) || 0;
        document.getElementById('cellTotal').innerText = (f1 + f2 + f3 + ye + proj).toLocaleString();
    }

    async function askPassword() {
        const p = prompt("è«‹è¼¸å…¥ä¸»ç®¡è§£é–å¯†ç¢¼ï¼š");
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "verifyPassword", password: p }) });
        const r = await res.json();
        if(r.status === "success") {
            document.getElementById('adminZone').style.display = 'block';
            document.getElementById('unlockBtn').style.display = 'none';
            loadYearTrend(); // è§£é–å¾ŒåŠ è¼‰æ­·å¹´åœ–
        } else alert("å¯†ç¢¼éŒ¯èª¤");
    }

    async function loadYearTrend() {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getPersonalTrend", empName: document.getElementById('selEmp').value }) });
        const r = await res.json();
        const ctx = document.getElementById('yearTrendChart').getContext('2d');
        if(yearTrendChart) yearTrendChart.destroy();
        yearTrendChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: r.data.map(d => d.year + 'å¹´'),
                datasets: [{ label: 'æ­·å¹´å¯¦é ˜ç¸½é¡', data: r.data.map(d => d.total), backgroundColor: '#27ae60' }]
            },
            options: { maintainAspectRatio: false, plugins: { datalabels: { color: '#fff' } } }
        });
    }

    async function handleFinalSave() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value);
        const projScores = Array.from(document.querySelectorAll('.p-score')).map(i => i.value);
        const adjs = [document.getElementById('adj_f1').value, document.getElementById('adj_f2').value, document.getElementById('adj_f3').value, document.getElementById('adj_ye').value];
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveRecord", 
                year: document.getElementById('calcYear').value, empName: document.getElementById('selEmp').value,
                rank: document.getElementById('selEmp').options[document.getElementById('selEmp').selectedIndex].dataset.rank,
                avgScore: document.querySelector('#resultBody td:nth-child(3)').innerText,
                f1: adjs[0], f2: adjs[1], f3: adjs[2], ye: adjs[3], 
                total: parseFloat(document.getElementById('cellTotal').innerText.replace(/,/g,'')),
                scores, projScores
            })
        });
        if((await res.json()).status === "success") {
            alert("âœ… å­˜æª”æˆåŠŸï¼");
            loadYearTrend();
        }
    }

    function updateScoreChart() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value===""?null:parseFloat(i.value));
        const ctx = document.getElementById('scoreChart').getContext('2d');
        if (scoreChart) scoreChart.destroy();
        scoreChart = new Chart(ctx, {
            type: 'line',
            data: { labels: scores.map((_,i)=>i+1), datasets: [{ label: 'å¹´åº¦ç¸¾æ•ˆè©•åˆ†', data: scores, borderColor: '#3498db' }] },
            options: { maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>
