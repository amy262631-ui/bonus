<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çé‡‘ç®¡ç†ç³»çµ± - å®‰å…¨å¼·åŒ–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --lock: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .score-container { display: flex; flex-wrap: wrap; gap: 8px; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .q-score, .p-score { width: 65px; height: 45px; text-align: center; border: 2px solid var(--accent); border-radius: 8px; font-size: 1.1rem; }
        .p-score { border-color: #e67e22; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--lock); }
        /* çé‡‘ä¿®æ”¹æ¡†æ¨£å¼ */
        .adjust-input { width: 100px; padding: 5px; color: var(--success); font-weight: bold; border: 2px dashed var(--success); text-align: center; border-radius: 4px; font-size: 1.1rem; }
        /* æ¨¡ç³Šé®ç½© */
        .secret-data { filter: blur(10px); pointer-events: none; transition: 0.4s; }
        .unlocked .secret-data { filter: none; pointer-events: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        .total-cell { background: #fff3cd; color: red; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="container">
    <div class="card">
        <h2>1. åˆ†æ•¸è¼¸å…¥ (åŠ©ç†) <span id="saveStatus" style="font-size:0.8rem; color:orange;"></span></h2>
        <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
            <div>é¸æ“‡å“¡å·¥ï¼š<select id="selEmp" onchange="updateUI()"></select></div>
            <div>å¹´åº¦ï¼š<input type="number" id="calcYear" value="2025" style="width:80px;"></div>
            <button class="btn btn-green" onclick="handleFinalSave()">âœ… ç¢ºèªé‡‘é¡ä¸¦å­˜æª”</button>
            <button class="btn" style="background:#95a5a6;" onclick="downloadChartJPG()">ä¸‹è¼‰è¶¨å‹¢ JPG</button>
        </div>

        <label><strong>ç¸¾æ•ˆåˆ†æ•¸ï¼š</strong></label>
        <div id="scoreInputs" class="score-container"></div>
        <label><strong>å°ˆæ¡ˆåˆ†æ•¸ (12å€‹æœˆ)ï¼š</strong></label>
        <div id="projInputs" class="score-container"></div>
        <div style="height: 350px;"><canvas id="trendChart"></canvas></div>
    </div>

    <div class="card" id="bonusZone">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>2. çé‡‘æ ¸å®š (å¯æ‰‹å‹•ä¿®æ”¹)</h2>
            <button class="btn btn-red" id="unlockBtn" onclick="askPassword()">ğŸ”’ è§£é–ç·¨è¼¯</button>
        </div>
        <div class="secret-data">
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th><th>ç¸¾æ•ˆå¹³å‡</th><th>å°ˆæ¡ˆçé‡‘</th>
                        <th>äº”ä¸€ (æ”¹)</th><th>ç«¯åˆ (æ”¹)</th><th>ä¸­ç§‹ (æ”¹)</th><th>å¹´çµ‚ (æ”¹)</th>
                        <th>æ‡‰ä»˜ç¸½è¨ˆ</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9kLPJjKS5XZsYmgy_Hk77YKKL7X_8qIJkQrNGyJLEcGb3XKrb0lotAjcNhRCL5EXB/exec"; 
    let trendChart = null;
    let currentCalcData = null;
    Chart.register(ChartDataLabels);

    window.onload = async () => {
        const res = await fetch(API_URL);
        const result = await res.json();
        const sel = document.getElementById('selEmp');
        sel.innerHTML = result.data.map(e => `<option value="${e.name}" data-rank="${e.rank}">${e.name} (${e.rank})</option>`).join('');
        updateUI();
    };

    // è·ç­‰é€£å‹•ï¼šè‡ªå‹•åˆ‡æ›æœˆ/å­£
    function updateUI() {
        const sel = document.getElementById('selEmp');
        const rank = sel.options[sel.selectedIndex].dataset.rank;
        const sBox = document.getElementById('scoreInputs');
        const pBox = document.getElementById('projInputs');
        
        let sCount = (rank === 'L1') ? 12 : 4;
        sBox.innerHTML = Array.from({length: sCount}, (_, i) => 
            `<div><small>${rank==='L1'?(i+1)+'æœˆ':'Q'+(i+1)}</small><br><input type="number" class="q-score" onchange="onChanged()"></div>`).join('');
        
        pBox.innerHTML = Array.from({length: 12}, (_, i) => 
            `<div><small>${i+1}æœˆ</small><br><input type="number" class="p-score" onchange="onChanged()"></div>`).join('');
        
        if (trendChart) trendChart.destroy();
        document.getElementById('resultBody').innerHTML = "";
    }

    function onChanged() { updateChart(); autoCalc(); }

    async function autoCalc() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value===""?null:parseFloat(i.value));
        const projScores = Array.from(document.querySelectorAll('.p-score')).map(i => i.value===""?null:parseFloat(i.value));
        
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "calculateBonus",
                empName: document.getElementById('selEmp').value,
                scores: scores, projScores: projScores,
                year: document.getElementById('calcYear').value
            })
        });
        const r = await res.json();
        if(r.status === "success") {
            currentCalcData = r.data;
            renderTable(r.data);
        }
    }

    function renderTable(d) {
        document.getElementById('resultBody').innerHTML = `
            <tr>
                <td>${document.getElementById('selEmp').value}</td>
                <td>${d.avgScore}</td>
                <td id="cellProj">${d.proj.toLocaleString()}</td>
                <td><input type="number" class="adjust-input" value="${d.f1}" oninput="refreshTotal()"></td>
                <td><input type="number" class="adjust-input" value="${d.f2}" oninput="refreshTotal()"></td>
                <td><input type="number" class="adjust-input" value="${d.f3}" oninput="refreshTotal()"></td>
                <td><input type="number" class="adjust-input" value="${d.ye}" oninput="refreshTotal()"></td>
                <td class="total-cell" id="cellTotal">${d.systemTotal.toLocaleString()}</td>
            </tr>`;
    }

    function refreshTotal() {
        const adjs = Array.from(document.querySelectorAll('.adjust-input')).map(i => parseFloat(i.value) || 0);
        const proj = parseFloat(document.getElementById('cellProj').innerText.replace(/,/g,'')) || 0;
        document.getElementById('cellTotal').innerText = (adjs.reduce((a,b)=>a+b,0) + proj).toLocaleString();
    }

    // å®‰å…¨é©—è­‰ï¼šè§£é–ä¸å†çœ‹å‰ç«¯ï¼Œè€Œæ˜¯ç™¼é€åˆ°å¾Œç«¯
    async function askPassword() {
        const p = prompt("è«‹è¼¸å…¥ä¸»ç®¡è§£é–å¯†ç¢¼ï¼š");
        if (!p) return;
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "verifyPassword", password: p })
        });
        const r = await res.json();
        if(r.status === "success") {
            document.getElementById('bonusZone').classList.add('unlocked');
            document.getElementById('unlockBtn').innerText = "ğŸ”“ å·²æˆæ¬Šç·¨è¼¯";
            document.getElementById('unlockBtn').classList.replace('btn-red', 'btn-green');
        } else { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); }
    }

    async function handleFinalSave() {
        if(!currentCalcData) return alert("è«‹å…ˆè¼¸å…¥åˆ†æ•¸");
        const adjs = Array.from(document.querySelectorAll('.adjust-input')).map(i => parseFloat(i.value) || 0);
        const finalTotal = parseFloat(document.getElementById('cellTotal').innerText.replace(/,/g,''));
        
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveRecord",
                year: document.getElementById('calcYear').value,
                empName: document.getElementById('selEmp').value,
                rank: currentCalcData.rank, avgScore: currentCalcData.avgScore,
                f1: adjs[0], f2: adjs[1], f3: adjs[2], ye: adjs[3], total: finalTotal
            })
        });
        if((await res.json()).status === "success") alert("âœ… å·²æˆåŠŸå­˜æª”ï¼");
    }

    function updateChart() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value===""?null:parseFloat(i.value));
        const labels = scores.map((_, i) => (i+1).toString());
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'ç¸¾æ•ˆè©•åˆ†', data: scores, borderColor: '#3498db', pointRadius: 6 }]
            },
            options: { maintainAspectRatio: false, plugins: { datalabels: { align: 'top', formatter: v => v || '' } } }
        });
    }

    function downloadChartJPG() {
        const canvas = document.getElementById('trendChart');
        const link = document.createElement('a');
        link.download = `è¶¨å‹¢åœ–_${document.getElementById('selEmp').value}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 1.0);
        link.click();
    }
</script>
</body>
</html>
