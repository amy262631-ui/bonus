<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çé‡‘ç®¡ç†ç³»çµ± - æ¬Šé™åˆ†ç«‹ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --lock: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .score-container { display: flex; flex-wrap: wrap; gap: 8px; background: #eef2f7; padding: 15px; border-radius: 10px; }
        .q-score { width: 60px; height: 35px; text-align: center; border: 2px solid var(--accent); border-radius: 6px; font-weight: bold; }
        #adminZone { display: none; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; margin: 5px; }
        .adjust-input { width: 90px; color: #d35400; font-weight: bold; border: 2px dashed #e67e22; text-align: center; background: #fffaf0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h2>1. ç¸¾æ•ˆåˆ†æ•¸è¼¸å…¥ (åŠ©ç†äººå“¡)</h2>
    <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
        å“¡å·¥ï¼š<select id="selEmp" onchange="initUI()"></select>
        å¹´åº¦ï¼š<input type="number" id="calcYear" value="2025" style="width:75px;" onchange="autoCalc()">
        <button class="btn" style="background:var(--accent);" onclick="handleSaveScores()">ğŸ’¾ åƒ…å„²å­˜åˆ†æ•¸</button>
        <button class="btn" style="background:var(--lock);" id="unlockBtn" onclick="askPassword()">ğŸ”’ ä¸»ç®¡è§£é–æ ¸å®š</button>
    </div>
    <div id="scoreInputs" class="score-container"></div>
    <div style="height: 200px; margin-top:10px;"><canvas id="scoreChart"></canvas></div>
</div>

<div id="adminZone">
    <div class="card">
        <h2 style="color:#e67e22">2. ä¸»ç®¡æ ¸å®šå°ˆå€ (æ¶‰åŠçé‡‘éš±ç§)</h2>
        <table style="background:#fffdf0; margin-bottom: 15px;">
            <thead><tr><th>å­£åº¦è·ç­‰/è–ªè³‡ç•°å‹•</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th></tr></thead>
            <tbody id="timelineBody"></tbody>
        </table>
        
        <table>
            <thead><tr style="background:#eee;"><th>å§“å</th><th>å¹´åº¦</th><th>å¹³å‡åˆ†</th><th>äº”ä¸€</th><th>ç«¯åˆ</th><th>ä¸­ç§‹</th><th>å¹´çµ‚</th><th>ç¸½è¨ˆ</th></tr></thead>
            <tbody id="resultBody"></tbody>
        </table>
        
        <div style="text-align:right; margin-top:20px;">
            <button onclick="handleFinalSave()" id="realSaveBtn" class="btn" style="background:var(--success); padding: 15px 40px; font-size: 1.1rem;">âœ… æ ¸å®šçé‡‘ä¸¦å­˜æª”</button>
        </div>
        <div style="height: 250px; margin-top:20px;"><canvas id="yearTrendChart"></canvas></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9kLPJjKS5XZsYmgy_Hk77YKKL7X_8qIJkQrNGyJLEcGb3XKrb0lotAjcNhRCL5EXB/exec"; 
    let scoreChart = null, yearTrendChart = null, timelineData = {}, empMaster = [];

    window.onload = async () => {
        const res = await fetch(API_URL);
        const r = await res.json();
        empMaster = r.data;
        document.getElementById('selEmp').innerHTML = empMaster.map(e => `<option value="${e.name}" data-rank="${e.rank}" data-salary="${e.salary}">${e.name}</option>`).join('');
        initUI();
    };

    function initUI() {
        const sel = document.getElementById('selEmp');
        const opt = sel.options[sel.selectedIndex];
        document.getElementById('scoreInputs').innerHTML = Array.from({length: (opt.dataset.rank==='L1'?12:4)}, (_, i) => 
            `<div><small>${i+1}${opt.dataset.rank==='L1'?'M':'Q'}</small><br><input type="number" class="q-score" oninput="updateScoreChart(); autoCalc();"></div>`).join('');
        timelineData = { Q1:{r:opt.dataset.rank, s:opt.dataset.salary}, Q2:{r:opt.dataset.rank, s:opt.dataset.salary}, Q3:{r:opt.dataset.rank, s:opt.dataset.salary}, Q4:{r:opt.dataset.rank, s:opt.dataset.salary} };
        renderTimeline();
        autoCalc();
    }

    // åŠ©ç†ç”¨çš„å­˜æª”æŒ‰éˆ•é‚è¼¯
    async function handleSaveScores() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveScoresOnly",
                year: document.getElementById('calcYear').value,
                empName: document.getElementById('selEmp').value,
                scores: scores
            })
        });
        if((await res.json()).status === "success") alert("âœ… åˆ†æ•¸æš«å­˜æˆåŠŸï¼ä¸»ç®¡è§£é–å¾Œå³å¯æ ¸å®šçé‡‘ã€‚");
    }

    async function autoCalc() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "calculateBonus", empName: document.getElementById('selEmp').value, year: document.getElementById('calcYear').value, scores, timeline: timelineData })
        });
        const r = await res.json();
        if(r.status === "success") {
            // è‡ªå‹•å›å¡«èˆŠåˆ†æ•¸
            if(r.historyScores) {
                const inputs = document.querySelectorAll('.q-score');
                r.historyScores.forEach((v, i) => { if (v !== null && inputs[i] && inputs[i].value === "") inputs[i].value = v; });
                updateScoreChart();
            }
            document.getElementById('resultBody').innerHTML = `
                <tr>
                    <td>${document.getElementById('selEmp').value}</td><td>${document.getElementById('calcYear').value}</td>
                    <td id="avgScoreDisplay">${r.data.avgScore}</td>
                    <td><input type="number" class="adjust-input" id="adj_f1" value="${r.data.f1}" oninput="refreshTotal()"></td>
                    <td><input type="number" class="adjust-input" id="adj_f2" value="${r.data.f2}" oninput="refreshTotal()"></td>
                    <td><input type="number" class="adjust-input" id="adj_f3" value="${r.data.f3}" oninput="refreshTotal()"></td>
                    <td><input type="number" class="adjust-input" id="adj_ye" value="${r.data.ye}" oninput="refreshTotal()"></td>
                    <td style="color:red; font-weight:bold;" id="totalCell">${(r.data.f1+r.data.f2+r.data.f3+r.data.ye).toLocaleString()}</td>
                </tr>`;
        }
    }

    // ä¸»ç®¡æ ¸å®šå­˜æª”
    async function handleFinalSave() {
        const adjs = ["f1","f2","f3","ye"].map(id => parseFloat(document.getElementById("adj_"+id).value) || 0);
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveRecord", year: document.getElementById('calcYear').value, empName: document.getElementById('selEmp').value,
                rank: timelineData.Q4.r, avgScore: document.getElementById('avgScoreDisplay').innerText,
                f1: adjs[0], f2: adjs[1], f3: adjs[2], ye: adjs[3], total: adjs.reduce((a,b)=>a+b,0),
                scores: scores, timeline: timelineData
            })
        });
        if((await res.json()).status === "success") alert("âœ… çé‡‘æ ¸å®šå­˜æª”æˆåŠŸï¼");
    }

    async function askPassword() {
        const p = prompt("ä¸»ç®¡å¯†ç¢¼ï¼š");
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "verifyPassword", password: p }) });
        if((await res.json()).status === "success") {
            document.getElementById('adminZone').style.display = 'block';
            document.getElementById('unlockBtn').style.display = 'none';
        } else alert("å¯†ç¢¼éŒ¯èª¤");
    }
    
    // å…¶é¤˜æ¸²æŸ“å‡½å¼ (updateScoreChart, refreshTotal, renderTimeline, loadTrend) ç¶­æŒä¸è®Š...
    function renderTimeline() {
        let hRank = "<tr><td>è·ç­‰</td>", hSalary = "<tr><td>æœˆè–ª</td>";
        for(let i=1; i<=4; i++) {
            hRank += `<td><select id="t_r_Q${i}"><option>L1</option><option>L2</option><option>L3</option><option>L4</option></select></td>`;
            hSalary += `<td><input type="number" id="t_s_Q${i}" style="width:70px"></td>`;
        }
        document.getElementById('timelineBody').innerHTML = hRank + "</tr>" + hSalary + "</tr>";
        for(let i=1; i<=4; i++) {
            document.getElementById(`t_r_Q${i}`).value = timelineData[`Q${i}`].r;
            document.getElementById(`t_s_Q${i}`).value = timelineData[`Q${i}`].s;
        }
    }
    function updateScoreChart() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value===""?null:parseFloat(i.value));
        const ctx = document.getElementById('scoreChart').getContext('2d');
        if (scoreChart) scoreChart.destroy();
        scoreChart = new Chart(ctx, { type: 'line', data: { labels: scores.map((_,i)=>i+1), datasets: [{ label: 'è©•åˆ†', data: scores, borderColor: '#3498db' }] }, options: { maintainAspectRatio: false } });
    }
    function refreshTotal() {
        const adjs = ["f1","f2","f3","ye"].map(id => parseFloat(document.getElementById("adj_"+id).value) || 0);
        document.getElementById('totalCell').innerText = adjs.reduce((a,b)=>a+b,0).toLocaleString();
    }
</script>
</body>
</html>
