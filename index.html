<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çé‡‘ç®¡ç†ç³»çµ± - ç°¡å ±å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --accent: #3498db; --lock: #e74c3c; --bg: #f4f7f6; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .q-score { width: 70px; height: 45px; font-size: 1.2rem; text-align: center; border: 2px solid var(--accent); border-radius: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-red { background: var(--lock); color: white; }
        .secret-data { filter: blur(6px); pointer-events: none; }
        .unlocked .secret-data { filter: none; pointer-events: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .adjust-input { width: 85px; margin-top: 5px; color: #27ae60; font-weight: bold; border: 1px dashed #27ae60; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="trendTitle">1. åˆ†æ•¸è¼¸å…¥èˆ‡åˆ†æ</h2>
    <div style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px;">
        <div>é¸æ“‡å“¡å·¥ï¼š<select id="selEmp" onchange="updateScoreUI()"></select></div>
        <div>å¹´åº¦ï¼š<input type="number" id="calcYear" value="2025" style="width: 80px;"></div>
        <div>å°ˆæ¡ˆåˆ†æ•¸ï¼š<input type="number" id="projScore" style="width: 60px;"></div>
        <button class="btn btn-blue" onclick="startCalc()">è¨ˆç®—çé‡‘</button>
        <button class="btn" onclick="downloadChart()">ä¸‹è¼‰åœ–è¡¨ JPG</button>
    </div>
    <div id="scoreInputs"></div>
    <div style="height: 300px; margin-top: 20px;"><canvas id="trendChart"></canvas></div>
</div>

<div class="card" id="bonusZone">
    <div style="display: flex; justify-content: space-between;">
        <h2>2. çé‡‘æ ¸å®š (ä¸»ç®¡å°ˆç”¨)</h2>
        <button class="btn btn-red" onclick="askPassword()">ğŸ”’ è§£é–é‡‘é¡</button>
    </div>
    <div class="secret-data">
        <table>
            <thead><tr><th>å§“å</th><th>å¹³å‡</th><th>äº”ä¸€ (ä¿®æ”¹)</th><th>ç«¯åˆ (ä¿®æ”¹)</th><th>ä¸­ç§‹ (ä¿®æ”¹)</th><th>å¹´çµ‚ (ä¿®æ”¹)</th><th>ç¸½è¨ˆ</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = "ä½ çš„APIç¶²å€"; // ğŸ‘ˆ ä¿®æ”¹æ­¤è™•
    let trendChart = null;
    let currentPwd = "";
    Chart.register(ChartDataLabels);

    window.onload = async () => {
        const res = await fetch(API_URL);
        const result = await res.json();
        const sel = document.getElementById('selEmp');
        sel.innerHTML = result.data.map(e => `<option value="${e.name}" data-rank="${e.rank}">${e.name} (${e.rank})</option>`).join('');
        updateScoreUI();
    };

    function updateScoreUI() {
        const sel = document.getElementById('selEmp');
        const rank = sel.options[sel.selectedIndex].dataset.rank;
        const box = document.getElementById('scoreInputs');
        document.getElementById('trendTitle').innerText = `1. åˆ†æ•¸è¼¸å…¥èˆ‡åˆ†æ - ${sel.value}`;
        
        let count = (rank === 'L1') ? 12 : 4;
        let html = '<div style="display:flex; flex-wrap:wrap; gap:10px;">';
        for(let i=1; i<=count; i++) {
            html += `<div><small>${i}${rank==='L1'?'æœˆ':'å­£'}</small><br><input type="number" class="q-score" value="" onchange="updateChart()"></div>`;
        }
        box.innerHTML = html + '</div>';
        updateChart();
    }

    function updateChart() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value==="" ? null : parseFloat(i.value));
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: scores.map((_, i) => i+1),
                datasets: [{ label: 'å¾—åˆ†', data: scores, borderColor: '#3498db', tension: 0.3, pointRadius: 6 }]
            },
            options: {
                plugins: { datalabels: { align: 'top', anchor: 'end', formatter: v => v } }
            }
        });
    }

    async function startCalc() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => parseFloat(i.value) || 0);
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "calculateBonus", password: currentPwd, empName: document.getElementById('selEmp').value, 
            scores: scores, projScore: document.getElementById('projScore').value, year: document.getElementById('calcYear').value })
        });
        const r = await res.json();
        if(r.status === "success") {
            const d = r.data;
            document.getElementById('resultBody').innerHTML += `
                <tr><td>${document.getElementById('selEmp').value}</td><td>${d.avgScore}</td>
                <td>${d.f1}<br><input type="number" class="adjust-input" value="${d.f1}"></td>
                <td>${d.f2}<br><input type="number" class="adjust-input" value="${d.f2}"></td>
                <td>${d.f3}<br><input type="number" class="adjust-input" value="${d.f3}"></td>
                <td>${d.ye}<br><input type="number" class="adjust-input" value="${d.ye}"></td>
                <td style="color:red; font-weight:bold;">${d.total}</td>
                <td><button onclick="saveToDB(this, ${d.avgScore})">å­˜æª”</button></td></tr>`;
        } else { alert(r.msg); }
    }

    function askPassword() {
        currentPwd = prompt("è¼¸å…¥å¯†ç¢¼ï¼š");
        if(currentPwd === "0000") document.getElementById('bonusZone').classList.add('unlocked');
    }

    async function saveToDB(btn, avg) {
        const row = btn.closest('tr');
        const adjs = Array.from(row.querySelectorAll('.adjust-input')).map(i => parseFloat(i.value));
        const total = adjs.reduce((a,b)=>a+b, 0);
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "saveRecord", password: currentPwd, empName: row.cells[0].innerText, year: document.getElementById('calcYear').value,
            rank: "N/A", avgScore: avg, f1: adjs[0], f2: adjs[1], f3: adjs[2], ye: adjs[3], total: total })
        });
        const r = await res.json();
        if(r.status==="success") { btn.innerText = "å·²å­˜"; btn.disabled = true; }
    }

    function downloadChart() {
        const link = document.createElement('a');
        link.download = `è¶¨å‹¢_${document.getElementById('selEmp').value}.jpg`;
        link.href = document.getElementById('trendChart').toDataURL('image/jpeg', 1.0);
        link.click();
    }
</script>
</body>
</html>
