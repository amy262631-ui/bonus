<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥ç¸¾æ•ˆèˆ‡çé‡‘ç®¡ç†ç³»çµ± - æœ€çµ‚ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --lock: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { border-left: 5px solid var(--accent); padding-left: 10px; margin-top: 0; }
        
        /* è¼¸å…¥åˆ—æ¨£å¼ */
        .input-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        
        /* åˆ†æ•¸è¼¸å…¥æ¡†åŠ å¤§ */
        .score-container { display: flex; flex-wrap: wrap; gap: 12px; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; }
        .q-score { width: 75px; height: 50px; font-size: 1.2rem; text-align: center; border: 2px solid var(--accent); border-radius: 8px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--lock); color: white; }
        
        /* çé‡‘è¡¨æ ¼èˆ‡æ¨¡ç³Šæ•ˆæœ */
        .secret-data { filter: blur(6px); transition: 0.5s; pointer-events: none; }
        .unlocked .secret-data { filter: none; pointer-events: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #f2f2f2; }
        
        /* å¯¦ä»˜ä¿®æ”¹æ¡† */
        .adjust-input { width: 90px; margin-top: 5px; color: var(--success); font-weight: bold; border: 1px dashed var(--success); text-align: center; }
        
        #chartArea { height: 350px; margin-top: 20px; background: #fff; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 id="trendTitle">1. åˆ†æ•¸è¼¸å…¥èˆ‡è¶¨å‹¢åˆ†æ</h2>
        <div class="input-row">
            <div class="input-group">
                <label>é¸æ“‡å“¡å·¥</label>
                <select id="selEmp" onchange="updateScoreUI()"></select>
            </div>
            <div class="input-group">
                <label>è€ƒè©•å¹´åº¦</label>
                <input type="number" id="calcYear" value="2025">
            </div>
            <div class="input-group">
                <label>å°ˆæ¡ˆåˆ†æ•¸</label>
                <input type="number" id="projScore" value="0" onchange="autoLiveCalc()">
            </div>
            <button class="btn btn-blue" onclick="downloadChartJPG()">ä¸‹è¼‰è¶¨å‹¢ JPG</button>
        </div>
        
        <div id="scoreInputs" class="score-container"></div>

        <div id="chartArea">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <div class="card" id="bonusZone">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>2. çé‡‘å³æ™‚è©¦ç®—èˆ‡æ ¸å®š</h2>
            <button class="btn btn-red" id="unlockBtn" onclick="askPassword()">ğŸ”’ è§£é–æ©Ÿå¯†é‡‘é¡</button>
        </div>
        
        <div class="secret-data">
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th><th>å¹´åº¦å¹³å‡</th>
                        <th>äº”ä¸€ (å¯¦ä»˜ä¿®æ”¹)</th><th>ç«¯åˆ (å¯¦ä»˜ä¿®æ”¹)</th>
                        <th>ä¸­ç§‹ (å¯¦ä»˜ä¿®æ”¹)</th><th>å¹´çµ‚ (å¯¦ä»˜ä¿®æ”¹)</th>
                        <th>ç¸½è¨ˆ</th><th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- è«‹å¡«å…¥ä½ çš„ Apps Script ç¶²å€ ---
    const API_URL = "https://script.google.com/macros/s/AKfycbz9kLPJjKS5XZsYmgy_Hk77YKKL7X_8qIJkQrNGyJLEcGb3XKrb0lotAjcNhRCL5EXB/exec";
    
    let currentAdminPwd = "";
    let trendChart = null;
    let empDataCache = [];
    Chart.register(ChartDataLabels);

    // åˆå§‹åŒ–ï¼šè¼‰å…¥å“¡å·¥åå–®
    window.onload = async () => {
        try {
            const res = await fetch(API_URL, { method: "GET", redirect: "follow" });
            const result = await res.json();
            if (result.status === "success") {
                empDataCache = result.data;
                const sel = document.getElementById('selEmp');
                sel.innerHTML = empDataCache.map(e => `<option value="${e.name}" data-rank="${e.rank}">${e.name} (${e.rank})</option>`).join('');
                updateScoreUI();
            }
        } catch (err) { console.error("API é€£ç·šéŒ¯èª¤:", err); }
    };

    // æ ¸å¿ƒé€£å‹•åŠŸèƒ½ï¼šåˆ‡æ›å“¡å·¥æ™‚é‡ç½® UI
    function updateScoreUI() {
        const sel = document.getElementById('selEmp');
        const rank = sel.options[sel.selectedIndex].dataset.rank;
        const empName = sel.value;
        const box = document.getElementById('scoreInputs');
        
        document.getElementById('trendTitle').innerText = `1. åˆ†æ•¸è¼¸å…¥èˆ‡åˆ†æ - ${empName} (${rank})`;
        
        let isL1 = (rank === 'L1');
        let count = isL1 ? 12 : 4;
        let unit = isL1 ? 'æœˆ' : 'å­£';

        // ç”Ÿæˆè¼¸å…¥æ¡†ä¸¦å¼·åˆ¶ã€Œå€¼ç‚ºç©ºã€(ä¸æ²¿ç”¨å‰ä¸€äººåˆ†æ•¸)
        let html = `<strong>${isL1 ? '12 å€‹æœˆè©•åˆ†' : 'Q1-Q4 å­£åº¦è©•åˆ†'}ï¼š</strong><br><div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;">`;
        for(let i=1; i<=count; i++) {
            let label = isL1 ? i : 'Q'+i;
            html += `<div style="text-align:center;"><small>${label}${isL1 ? 'æœˆ':''}</small><br>
                     <input type="number" class="q-score" value="" placeholder="-" onchange="onInputChanged()"></div>`;
        }
        box.innerHTML = html + `</div>`;
        updateChart(); // é‡ç½®è¶¨å‹¢åœ–
        document.getElementById('resultBody').innerHTML = ""; // æ¸…ç©ºå‰ä¸€äººçé‡‘è¡¨
    }

    // ç›£è½è®Šå‹•ï¼šå¡«å…¥åˆ†æ•¸å³é€£å‹•åœ–è¡¨èˆ‡è©¦ç®—
    function onInputChanged() {
        updateChart();
        const allInputs = Array.from(document.querySelectorAll('.q-score'));
        if (allInputs.some(i => i.value !== "")) {
            autoLiveCalc(); 
        }
    }

    // è¶¨å‹¢åœ–ï¼šé»é»é¡¯ç¤ºåˆ†æ•¸
    function updateChart() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        const labels = scores.map((_, i) => {
            const rank = document.getElementById('selEmp').options[document.getElementById('selEmp').selectedIndex].dataset.rank;
            return rank === 'L1' ? (i+1)+'æœˆ' : 'Q'+(i+1);
        });
        
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å€‹äººè©•åˆ†',
                    data: scores,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 6,
                    pointBackgroundColor: '#2c3e50'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    datalabels: { // é»é»é¡¯ç¤ºåˆ†æ•¸æ•¸å€¼
                        align: 'top', anchor: 'end', backgroundColor: '#2c3e50', color: 'white', borderRadius: 4, font: { weight: 'bold' },
                        formatter: v => v === null ? '' : v
                    },
                    legend: { display: false }
                }
            }
        });
    }

    // å³æ™‚è©¦ç®—å‡½å¼ (åªè¦æœ‰ä¸€å€‹åˆ†æ•¸å°±è¨ˆç®—)
    async function autoLiveCalc() {
        const scores = Array.from(document.querySelectorAll('.q-score')).map(i => i.value === "" ? null : parseFloat(i.value));
        const name = document.getElementById('selEmp').value;
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "calculateBonus",
                password: "0000", // å³æ™‚é¡¯ç¤ºä¸è¨­é™ï¼Œåƒ…å­˜æª”éœ€é©—è­‰
                empName: name,
                scores: scores,
                projScore: document.getElementById('projScore').value,
                year: document.getElementById('calcYear').value
            })
        });
        const r = await res.json();
        if(r.status === "success") {
            const d = r.data;
            document.getElementById('resultBody').innerHTML = `
                <tr>
                    <td>${name}</td><td>${d.avgScore}</td>
                    <td>${d.f1.toLocaleString()}<br><input type="number" class="adjust-input" value="${d.f1}"></td>
                    <td>${d.f2.toLocaleString()}<br><input type="number" class="adjust-input" value="${d.f2}"></td>
                    <td>${d.f3.toLocaleString()}<br><input type="number" class="adjust-input" value="${d.f3}"></td>
                    <td>${d.ye.toLocaleString()}<br><input type="number" class="adjust-input" value="${d.ye}"></td>
                    <td style="color:red; font-weight:bold;" id="totalDisplay">${d.systemTotal.toLocaleString()}</td>
                    <td><button class="btn btn-blue" onclick="finalSave(this, '${name}', '${d.rank}', ${d.avgScore})">æ­£å¼å­˜æª”</button></td>
                </tr>
            `;
        }
    }

    // æ­£å¼å­˜æª”é‚è¼¯
    async function finalSave(btn, name, rank, avg) {
        const p = prompt("è«‹è¼¸å…¥ä¸»ç®¡å¯†ç¢¼ç¢ºèªå­˜æª”ï¼š");
        if(p !== "0000") return alert("å¯†ç¢¼éŒ¯èª¤ï¼");

        const row = btn.closest('tr');
        const adjs = Array.from(row.querySelectorAll('.adjust-input')).map(i => parseFloat(i.value));
        const total = adjs.reduce((a, b) => a + b, 0);

        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveRecord",
                password: p,
                year: document.getElementById('calcYear').value,
                empName: name, rank, avgScore: avg,
                f1: adjs[0], f2: adjs[1], f3: adjs[2], ye: adjs[3], total: total
            })
        });
        const r = await res.json();
        if(r.status === "success") {
            alert("è³‡æ–™å·²æˆåŠŸå¯«å…¥ Google Sheets (Bonus_Records)ï¼");
            btn.innerText = "å·²å­˜æª”";
            btn.disabled = true;
        }
    }

    // åœ–è¡¨ JPG ä¸‹è¼‰ (å«äººåæ¨™é¡Œ)
    function downloadChartJPG() {
        const name = document.getElementById('selEmp').value;
        const canvas = document.getElementById('trendChart');
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width; tempCanvas.height = canvas.height + 60;
        const ctx = tempCanvas.getContext('2d');
        ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        ctx.fillStyle = "#2c3e50"; ctx.font = "bold 22px Microsoft JhengHei";
        ctx.fillText(`å“¡å·¥ç¸¾æ•ˆè¶¨å‹¢åœ– - ${name}`, 25, 40);
        ctx.drawImage(canvas, 0, 60);
        const link = document.createElement('a');
        link.download = `è¶¨å‹¢_${name}.jpg`;
        link.href = tempCanvas.toDataURL('image/jpeg', 1.0);
        link.click();
    }

    // è§£é–é‡‘é¡æ©Ÿåˆ¶
    function askPassword() {
        const p = prompt("è«‹è¼¸å…¥ä¸»ç®¡ç®¡ç†å¯†ç¢¼ï¼š");
        if(p === "0000") {
            currentAdminPwd = p;
            document.getElementById('bonusZone').classList.add('unlocked');
            document.getElementById('unlockBtn').innerText = "ğŸ”“ å·²æˆæ¬Šé¡¯ç¤ºé‡‘é¡";
            document.getElementById('unlockBtn').classList.replace('btn-red', 'btn-green');
        } else { alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•è§£é–ï¼"); }
    }
</script>
</body>
</html>
